<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const supabase = createClient(
    'https://lmcawwcrwqtmylhcbqwi.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtY2F3d2Nyd3F0bXlsaGNicXdpIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzEwMTUwOCwiZXhwIjoyMDY4Njc3NTA4fQ.YCd4Zx0C1gyxjCyiXLrXXoj0FOeuXt1YAGJEqbzTL34'
  );

  const utente = JSON.parse(localStorage.getItem("utenteLoggato"));
  const ruolo = utente?.ruolo;

  if (!utente || ruolo === "Analista") {
    document.getElementById("permesso_negato").style.display = "block";
  } else {
    document.getElementById("form_container").style.display = "block";
  }

  document.getElementById("salva_btn").addEventListener("click", async () => {
    const gruppi = Array.from(document.querySelectorAll("#gruppo input:checked")).map(cb => cb.value);
    const nuovoDip = {
      nome: document.getElementById("nome").value,
      email: document.getElementById("email").value,
      password: document.getElementById("password").value,
      telefono_fisso: document.getElementById("telefono_fisso").value,
      cellulare: document.getElementById("cellulare").value,
      gruppo: gruppi.join(", "),
      ruolo: document.getElementById("ruolo").value,
      tipo_turno: document.getElementById("tipo_turno").value,
      ore_accumulate: parseFloat(document.getElementById("ore_accumulate").value) || 0,
      ore_annuali: parseFloat(document.getElementById("ore_annuali").value) || 0
    };

    const messaggio = document.getElementById("messaggio");

    try {
      const { data, error: signupError } = await supabase.auth.admin.createUser({
        email: nuovoDip.email,
        password: nuovoDip.password,
        email_confirm: true
      });

      if (signupError) {
        messaggio.textContent = "Errore creazione utente: " + signupError.message;
        return;
      }

      const id = data?.user?.id;
      if (!id) {
        messaggio.textContent = "Errore: ID utente non restituito.";
        return;
      }

      const { error: dbError } = await supabase.from("dipendenti").insert({
        id,
        email: nuovoDip.email,
        nome: nuovoDip.nome,
        cellulare: nuovoDip.cellulare,
        telefono_fisso: nuovoDip.telefono_fisso,
        gruppo: nuovoDip.gruppo,
        ruolo: nuovoDip.ruolo,
        tipo_turno: nuovoDip.tipo_turno,
        ore_accumulate: nuovoDip.ore_accumulate,
        ore_annuali: nuovoDip.ore_annuali,
        attivo: true
      });

      if (dbError) {
        messaggio.textContent = "Errore inserimento DB: " + dbError.message;
        return;
      }

      alert("Dipendente creato correttamente.");
      window.location.href = "home.html";

    } catch (e) {
      messaggio.textContent = "Errore imprevisto: " + e.message;
    }
  });
</script>
