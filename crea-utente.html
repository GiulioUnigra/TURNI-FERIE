<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Registrazione Utente</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fdf9;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
    }
    .checkbox-group label {
      margin-right: 10px;
    }
    .error {
      color: red;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üßë‚Äçüíº Registrazione Nuovo Dipendente</h2>

    <label for="nome">Nome</label>
    <input id="nome" type="text" required>

    <label for="email">Email</label>
    <input id="email" type="email" required>

    <label for="password">Password</label>
    <input id="password" type="password" required>

    <label>Gruppo</label>
    <div id="gruppo" class="checkbox-group">
      <label><input type="checkbox" value="Cioccolato">Cioccolato</label>
      <label><input type="checkbox" value="Microbiologia">Microbiologia</label>
      <label><input type="checkbox" value="Oli">Oli</label>
      <label><input type="checkbox" value="Allergeni">Allergeni</label>
      <label><input type="checkbox" value="Contaminanti">Contaminanti</label>
      <label><input type="checkbox" value="Infoclienti">Infoclienti</label>
      <label><input type="checkbox" value="Confezionati">Confezionati</label>
      <label><input type="checkbox" value="Materie Prime">Materie Prime</label>
    </div>

    <button id="salva_btn">Crea Dipendente</button>
    <div id="messaggio" class="error"></div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://lmcawwcrwqtmylhcbqwi.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." // ANON KEY QUI
    );

    document.getElementById("salva_btn").addEventListener("click", async () => {
      const nome = document.getElementById("nome").value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const gruppi = Array.from(document.querySelectorAll("#gruppo input:checked")).map(cb => cb.value).join(", ");
      const messaggio = document.getElementById("messaggio");

      if (!nome || !email || !password || gruppi.length === 0) {
        messaggio.textContent = "Compila tutti i campi obbligatori.";
        return;
      }

      const { data, error } = await supabase.auth.signUp({
        email,
        password
      });

      if (error) {
        messaggio.textContent = "Errore: " + error.message;
        return;
      }

      const userId = data?.user?.id;
      if (!userId) {
        messaggio.textContent = "Utente creato, ma ID non trovato.";
        return;
      }

      const { error: insertError } = await supabase.from("dipendenti").insert({
        id: userId,
        email,
        nome,
        gruppo: gruppi,
        ruolo: "Analista", // ruolo predefinito per sicurezza
        attivo: true,
        ore_accumulate: 0,
        ore_annuali: 0
      });

      if (insertError) {
        messaggio.textContent = "Errore nel salvataggio DB: " + insertError.message;
        return;
      }

      alert("Utente creato con successo!");
      window.location.href = "home.html";
    });
  </script>
</body>
</html>
