<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Home - Dipendenti</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3fdf3;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }
    .btn {
      display: inline-block;
      margin: 10px 5px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 5px;
    }
    .btn:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <h2>Benvenuto</h2>
  <div id="contenuto"></div>
  <a href="#" class="btn" onclick="logout()">Logout</a>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const supabase = createClient(
      'https://lmcawwcrwqtmylhcbqwi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtY2F3d2Nyd3F0bXlsaGNicXdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDE1MDgsImV4cCI6MjA2ODY3NzUwOH0.mR9jK7S9Bkdf75XqLcMKj7nvRFqmMWLj9Km2QZ6uluE'
    );

    const utente = JSON.parse(localStorage.getItem("utenteLoggato"));
    const contenuto = document.getElementById("contenuto");

    async function mostraPersonale() {
      const { data, error } = await supabase
        .from("dipendenti")
        .select("nome, email, gruppo, ruolo, tipo_turno, ore_accumulate, ore_annuali")
        .eq("email", utente.email)
        .single();

      if (error) {
        contenuto.innerHTML = `<p>Errore nel caricamento dati personali.</p>`;
        return;
      }

      const ferie = await supabase
        .from("ferie")
        .select("giorni")
        .eq("email_dipendente", utente.email)
        .eq("stato", "Approvata");

      const oreFruite = ferie.data.reduce((acc, f) => acc + f.giorni, 0);
      const oreResidue = (data.ore_accumulate + data.ore_annuali - oreFruite).toFixed(2);

      contenuto.innerHTML = `
        <div class="card">
          <h3>${data.nome}</h3>
          <p><strong>Email:</strong> ${data.email}</p>
          <p><strong>Ruolo:</strong> ${data.ruolo}</p>
          <p><strong>Gruppo:</strong> ${data.gruppo}</p>
          <p><strong>Tipo turno:</strong> ${data.tipo_turno}</p>
          <p><strong>Ore accumulate:</strong> ${data.ore_accumulate}</p>
          <p><strong>Monte ore annuali:</strong> ${data.ore_annuali}</p>
          <p><strong>Ore fruite:</strong> ${oreFruite}</p>
          <p><strong>Ore residue:</strong> ${oreResidue}</p>
        </div>
        <a href="richieste.html" class="btn">Richiesta Ferie</a>
        <a href="calendario.html" class="btn">Calendario</a>
        ${utente.ruolo !== 'Analista' ? `<a href="gestione-dipendenti.html" class="btn">Gestione Dipendenti</a>` : ''}
        ${['Referente', 'Responsabile', 'Viceresponsabile'].includes(utente.ruolo) ? `<a href="riepilogo.html" class="btn">Riepilogo Dipendenti</a>` : ''}
      `;
    }

    function logout() {
      localStorage.removeItem("utenteLoggato");
      window.location.href = "index.html";
    }

    mostraPersonale();
  </script>
  
  <script>
  function logout() {
    localStorage.removeItem("utenteLoggato");
    window.location.href = "index.html";
  }
</script>
</body>
</html>
